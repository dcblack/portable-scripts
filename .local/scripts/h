#!/usr/bin/env bash

(return 0 2>/dev/null) && SOURCED=1 || SOURCED=0

function h() { # Display most recent N history lines
  if [[ -n "${ZSH_VERSION}" ]]; then set -o shwordsplit ; fi
  local N MATCH="" ROWS
  ROWS=$(Rows)
  (( N=4 - ROWS ))
  while [[ $# -gt 0 ]]; do
    if [[ "$1" =~ ^-[0-9]+$ ]]; then
      N="$1"
      shift
    elif [[ "$1" =~ ^[0-9]+$ ]]; then
      N="-$1"
      shift
    elif [[ "$1" =~ ^- ]]; then
      Report_error "Unknown option $1"
      return 1
    else
      MATCH="$1"
      shift
    fi
  done
  #shellcheck disable=SC2016
  local PERLSCRIPT='
    BEGIN {
      $m = qq{@ARGV};
      @ARGV=();
    }
    print "<$m>";
    for(reverse <>){
      chomp;
      next unless m/^ *\d+ +(.+)/;
      $a = $1;
      next if exists $p{$a};
      next if length($m)!=0  and not $a =~ m{$m};
      unshift @o,$_;
      $p{$a}++;
    };
    for(@o){print}
  '
  history | perl -lne "${PERLSCRIPT}" "${MATCH}" | tail "${N}"
}

if [[ ${SOURCED} == 0 ]]; then
  h "$@"
fi
