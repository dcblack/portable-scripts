#!/usr/bin/env bash
#
# Script to build/install Silver searcher, the fastest file searching tool on the planet!
TOOL_NAME="Silver searcher (ag)"
TOOL_INFO="Use 'ag --help' for more information."
TOOL_SRC="the_silver_searcher"
TOOL_URL="https://github.com/ggreer/the_silver_searcher.git"

SCRIPT="$(dirname "$0")/utils.bash"
if [[ -x "${SCRIPT}" ]]; then
  # shellcheck source=utils.bash
  source "${SCRIPT}" "$0"
else
  echo "Error: Missing ${SCRIPT}" 1>&2; exit 1
fi

GetBuildOpts "$0" "$@"
ConfirmBuildOpts

cd "${SRC}" || Die "Unable to enter source directory"
if [[ -n "${CLEAN}" && "${CLEAN}" == 1 ]]; then
  rm -fr "${TOOL_SRC}"
fi
if [[ -d "${TOOL_SRC}/.git" ]]; then
  Do git pull
else
  if [[ -d "${TOOL_SRC}/." ]]; then
    Do mkdir -p "${TOOL_SRC}-save"
    Do rsync -a "${TOOL_SRC}/" "${TOOL_SRC}-save/"
    Do rm -fr "${TOOL_SRC}" 
  fi
  Do git clone "${TOOL_URL}" "${TOOL_SRC}" || Die "Unable to clone"
fi
cd "${TOOL_SRC}" || Die "Unable to enter repo"
Info "Configuring ${TOOL_NAME}"
Do ./build.sh --prefix="${APPS}" || Die "Unable to build"
Info "Installing ${TOOL_NAME}"
Do make install
Summary ag "Installed. ${TOOL_INFO}"
if [[ -n "${CLEANUP}" && "${CLEANUP}" == 1 ]]; then
  cd "${SRC}" || Die "Unable to enter source directory"
  rm -fr "${TOOL_SRC}"
fi
