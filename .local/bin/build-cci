#!/usr/bin/env bash
#
# Script to build CCI for SystemC
TOOL_NAME="SystemC Control, Configuration and Inspection (CCI)"
TOOL_INFO="Go to 'https://accellera.org/downloads/standards/systemc' for more information."
TOOL_SRC="cci"
TOOL_URL="git@github.com:OSCI-WG/cci.git"

function Realpath() {
  if [[ $# == 0 ]]; then set - .; fi
  /usr/bin/perl '-MCwd(abs_path)' -le '$p=abs_path(join(q( ),@ARGV));print $p if -e $p' "$*"
}

SCRIPT="$(dirname $(Realpath "$0"))/utils.bash"
if [[ -x "${SCRIPT}" ]]; then
  # shellcheck source=utils.bash
  source "${SCRIPT}" "$0"
else
  echo "Error: Missing ${SCRIPT}" 1>&2; exit 1
fi

SetupLogdir "$0"

GetBuildOpts "$0" "$@"
ConfirmBuildOpts || exit

Create_and_Cd "${SRC}"

# Validate that SystemC exists
if [[ ! -d "${SYSTEMC_HOME}/include" ]]; then
  Die "Missing SystemC installation or SYSTEMC_HOME moved"
fi
if [[ ! -d "${CCI_HOME}/src" ]]; then
  Die "Missing CCI source or CCI_HOME moved"
fi

GitClone_and_Cd "${TOOL_SRC}" "${TOOL_URL}"

if [[ "${GENERATE_DOCS}" == 1 ]]; then
  Report_info "Build documentation"
  cd "${CCI_HOME}/doc"
  doxygen cci_doxygen_api_ref.conf
  doxygen cci_doxygen_examples.conf
  #doxygen cci_doxygen_gs_impl_ref.conf
fi

Report_info "Compile library"
cd "${CCI_HOME}/src"
make V=1

Report_info "Finished installation of CCI into ${CCI_HOME}"
