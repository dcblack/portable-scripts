#!/usr/bin/env bash
#
#  dotest - runs test scripts in the ${LOCAL}/tests directory

function Realpath ()
{
  /usr/bin/perl '-MCwd(abs_path)' -le '$p=abs_path(join(q( ),@ARGV));print $p if -e $p' "$*"
}

function DoTest() {
  SCRIPTDIR="$(Realpath "$(dirname "$1")"/../scripts)"
  if [[ ! -d "${SCRIPTDIR}" ]]; then
    printf "FATAL: Missing required directory '%s'\n" "${SCRIPTDIR}"
    return 1
  fi
  shift
  # shellcheck disable=SC2250,SC1091
  source "$SCRIPTDIR/Essential-IO"

  if [[ -z "${TESTDIR}" ]]; then
    TESTDIR="${HOME}/.local/tests"
  fi
  if [[ ! -d "${TESTDIR}" ]]; then
    Report_error "Missing ${TESTDIR}"
    return 1
  fi

  PGM="${TESTDIR}/test-$1"
  shift
  if [[ -e "${PGM}" && -x "${PGM}" ]]; then
    "${PGM}" "$@"
  else
    Report_error "No such test ${PGM}"
  fi
}

DoTest "$0" "$@"
