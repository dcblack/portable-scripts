#!/bin/bash
#
# Steps to build and install SystemC

#-------------------------------------------------------------------------------
# The following is formatted for use with -help
#|
#|NAME
#|----
#|
#|  $0 - build and install systemc from github source
#|
#|SYNOPSIS
#|--------
#|
#|  $0 -help
#|  $0 [OPTIONS...]
#|
#|DESCRIPTION
#|-----------
#|
#|  Downloads, unpacks, builds and installs the latest or specified version of cmake.
#|
#|OPTIONS
#|-------
#|  --cc=C_COMPILER | CC=C_COMPILER
#|  --clang
#|  --cxx=CPP_COMPILER | CXX=CPP_COMPILER
#|  --debug # developer use
#|  --gcc
#|  --install=DIR | -i DIR
#|  --src=DIR | -s DIR
#|  --std=N | -std=N
#|

SCRIPT="$(dirname "$0")/reporting.bash"
if [[ -f "${SCRIPT}" ]]; then
  # shellcheck source=reporting.bash
  source "${SCRIPT}" "$0"
else
  echo "Error: Missing ${SCRIPT}" 1>&2; exit 1
fi

# shellcheck source=get-build-opts.bash
Require get-build-opts.bash
GetBuildOpts "$0" "$@"

#-------------------------------------------------------------------------------
# Environment variables - MODIFY TO SUITE YOUR NEEDS
SYSTEMC_HOME="${APPS}/systemc" # <----- THIS IS WHERE INSTALLED VERSION GOES
CMAKE_INSTALL_PREFIX="${SYSTEMC_HOME}"
BUILD=build-cmake-"$(basename "${CC}")"

export SYSTEMC_HOME
export CMAKE_INSTALL_PREFIX CMAKE_CXX_STANDARD
export BUILD CXX CC

if [[ "${DEBUG}" == 1 ]]; then
  echo "BUILD=${BUILD}"
  echo "CC=${CC}"
# echo "CLEAN=${CLEAN}"
  echo "CMAKE_INSTALL_PREFIX=${CMAKE_INSTALL_PREFIX}"
  echo "CMAKE_CXX_STANDARD=${CMAKE_CXX_STANDARD}"
  echo "CXX=${CXX}"
# echo "DEBUG=${DEBUG}"
  echo "SYSTEMC_HOME=${SYSTEMC_HOME}"
  exit
fi

#-------------------------------------------------------------------------------
Info "Obtaining SystemC source"
if [[ -d systemc/.git ]]; then
  cd systemc || Die "Unable to enter repo directory"
  git pull
else
  # Download
  git clone "${GIT_URL}" || Die "Unable to clone"
  cd systemc || Die "Unable to enter repo directory"
fi

Info "Compiling SystemC"
rm -fr "${BUILD}"
mkdir "${BUILD}" || Die "Unable to create build directory"
cd "${BUILD}" || Die "Unable to enter ${BUILD} directory"
cmake ..

# Establish preferences
perl -pi -e '$v=q{CMAKE_INSTALL_PREFIX};if(m{^$v:}){s{=.*}{=$ENV{$v}}}' CMakeCache.txt
perl -pi -e '$v=q{CMAKE_CXX_STANDARD};if(m{^$v:}){s{=.*}{=$ENV{$v}}}' CMakeCache.txt
touch ../systemc/docs/tlm/ChangeLog
cmake ..

make
make check
Info "Installing SystemC to final location"
make install

Info "Finished installation of SystemC into ${SYSTEMC_HOME}"

# vim:nospell
