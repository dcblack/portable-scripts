#!/usr/bin/env bash
#
# Steps to build and install SystemC
TOOL_NAME="SystemC"
TOOL_INFO='Go to 'https://accellera.org/downloads/standards/systemc' for more information.'
TOOL_SRC="systemc"
TOOL_URL="https://github.com/accellera-official/systemc.git"
TOOL_VERS=2.3.3

#-------------------------------------------------------------------------------
# The following is formatted for use with -help
#|
#|NAME
#|----
#|
#|  $0 - build and install systemc from github source
#|
#|SYNOPSIS
#|--------
#|
#|  $0 -help
#|  $0 [OPTIONS...]
#|
#|DESCRIPTION
#|-----------
#|
#|  Downloads, unpacks, builds and installs the latest or specified version of SystemC.
#|
#|OPTIONS
#|-------
#|  --cc=C_COMPILER | CC=C_COMPILER
#|  --clang
#|  --cxx=CPP_COMPILER | CXX=CPP_COMPILER
#|  --debug # developer use
#|  --gcc
#|  --install=DIR | -i DIR
#|  --src=DIR | -s DIR
#|  --std=N | -std=N
#|

function Realpath () {
  /usr/bin/perl '-MCwd(abs_path)' -le "print abs_path(qq($*)) if -e qq($*)"
}

SCRIPT="$(Realpath "$0")"
SCRIPT="$(dirname "${SCRIPT}")/utils.bash"
if [[ -x "${SCRIPT}" ]]; then
  # shellcheck source=utils.bash
  source "${SCRIPT}" "$0"
else
  echo "Error: Missing ${SCRIPT}" 1>&2; exit 1
fi
SetupLogdir "$0"

GetBuildOpts "$0" "$@"
CMAKE_INSTALL_PREFIX="${SYSTEMC_HOME}"
ConfirmBuildOpts || exit

Create_and_Cd "${SRC}"
Info -grn "Obtaining ${TOOL_NAME} source"
GetSource_and_Cd "${TOOL_SRC}" "${TOOL_URL}"

Info -grn "Compiling ${TOOL_NAME}"
Generate "${GENERATOR}" | Log
_do make | Log
_do make check | Log

if [[ -z "${NOINSTALL+x}" ]]; then
  Info -grn "Installing ${TOOL_NAME} to final location"
  _do make install | Log

  # Optional clean up
  if [[ "${CLEAN}" == 1 ]]; then
    Info -red "Clean up"
    cd "${SRC}" || Die "Unable to enter source directory"
    rm -fr "${TOOL_NAME}"* | Log
  fi

  Info -grn "Finished installation of ${TOOL_NAME} into ${SYSTEMC_HOME}"
else
  Info -mag "Stopped shy installing ${TOOL_NAME}"
fi

# vim:nospell
