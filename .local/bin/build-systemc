#!/bin/bash
#
# Steps to build and install SystemC

#-------------------------------------------------------------------------------
# The following is formatted for use with -help
#|
#|NAME
#|----
#|
#|  $0 - build and install systemc from github source
#|
#|SYNOPSIS
#|--------
#|
#|  $0 -help
#|  $0 [OPTIONS...]
#|
#|DESCRIPTION
#|-----------
#|
#|  Downloads, unpacks, builds and installs the latest or specified version of cmake.
#|
#|OPTIONS
#|-------
#|  --cc=C_COMPILER | CC=C_COMPILER
#|  --clang
#|  --cxx=CPP_COMPILER | CXX=CPP_COMPILER
#|  --debug # developer use
#|  --gcc
#|  --install=DIR | -i DIR
#|  --src=DIR | -s DIR
#|  --std=N | -std=N
#|

function Realpath () {
  /usr/bin/perl '-MCwd(abs_path)' -le "print abs_path(qq($*))"
}

SCRIPT="$(dirname $(Realpath "$0"))/utils.bash"
if [[ -x "${SCRIPT}" ]]; then
  # shellcheck source=utils.bash
  source "${SCRIPT}" "$0"
else
  echo "Error: Missing ${SCRIPT}" 1>&2; exit 1
fi
SetupLogdir "$0"

GetBuildOpts "$0" "$@"

#-------------------------------------------------------------------------------
# Environment variables - MODIFY TO SUITE YOUR NEEDS
TARGET='systemc'
GIT_URL="https://github.com/accellera-official/systemc.git"
VERSION_TAG=2.3.3
SYSTEMC_HOME="${APPS}/systemc" # <----- THIS IS WHERE INSTALLED VERSION GOES
BUILD=build-cmake-"$(basename "${CC}")"
CMAKE_INSTALL_PREFIX="${SYSTEMC_HOME}"

export SYSTEMC_HOME
export CMAKE_INSTALL_PREFIX CMAKE_CXX_STANDARD
export BUILD CXX CC

if [[ "${DEBUG}" == 1 ]]; then
  Debug "BUILD=${BUILD}"
  Debug "CC=${CC}"
  Debug "CMAKE_INSTALL_PREFIX=${CMAKE_INSTALL_PREFIX}"
  Debug "CMAKE_CXX_STANDARD=${CMAKE_CXX_STANDARD}"
  Debug "CXX=${CXX}"
  Debug "SRC=${SRC}"
  Debug "SYSTEMC_HOME=${SYSTEMC_HOME}"
  Debug
fi

#-------------------------------------------------------------------------------
Info -grn "Obtaining SystemC source"
cd "${SRC}" || Die "Unable to change into source directory '${SRC}'"
if [[ -d systemc/.git ]]; then
  cd systemc || Die "Unable to enter repo directory"
  Do git pull
else
  # Download
  Do git clone "${GIT_URL}" || Die "Unable to clone"
  cd systemc || Die "Unable to enter repo directory"
fi
if [[ -s ${VERSION_TAG} ]]; then
  Do git  checkout "${VERSION_TAG}"
fi

Info -grn "Compiling SystemC"
Do rm -fr "${BUILD}"
Do mkdir "${BUILD}" || Die "Unable to create build directory"
cd "${BUILD}" || Die "Unable to enter ${BUILD} directory"
Do cmake ..

# Establish preferences
perl -pi -e '$v=q{CMAKE_CXX_STANDARD};if(m{^$v:}){s{=.*}{=$ENV{$v}}}' CMakeCache.txt
perl -pi -e '$v=q{CMAKE_INSTALL_PREFIX};if(m{^$v:}){s{=.*}{=$ENV{$v}}}' CMakeCache.txt
touch ../systemc/docs/tlm/ChangeLog
Info "Modifed CMakeCache.txt to specify CMAKE_CXX_STANDARD=${CMAKE_CXX_STANDARD} and CMAKE_INSTALL_PREFIX=${CMAKE_INSTALL_PREFIX}"
Do cmake ..

Do make
Do make check
Info -grn "Installing SystemC to final location"
Do make install

Info -grn "Finished installation of SystemC into ${SYSTEMC_HOME}"

# vim:nospell
