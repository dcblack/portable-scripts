#!/usr/bin/env bash
#
#| NAME
#|
#| update-local - update local files if they exist in the specified master directories
#|
#| SYNOPSYS
#|
#| update-local --help|-h
#| update-local [-C TO_DIR] [FROM_DIRECTORIES]

function Realpath()
{ 
  if [[ $# == 0 ]]; then set - .; fi
  /usr/bin/perl '-MCwd(abs_path)' -le '$p=abs_path(join(q( ),@ARGV));print $p if -e $p' "$*"
}

function Excluded()
{
  local File Exclude
  File="$1"; shift
  for Exclude in "$@"; do
    if [[ "${File}" == "${Exclude}" ]]; then return 0; fi
  done
  return 1
}

function Update-local()
{
  export SCRIPTS_DIR
  # If not yet defined
  if [[ -z "${SCRIPTS_DIR}" ]]; then
    # Try the directory where build is located
    SCRIPTS_DIR="$(dirname "$0")"
  fi
  if [[ ! -f "${SCRIPTS_DIR}/Essential-IO" ]]; then
    # Try home installation
    SCRIPTS_DIR="${HOME}/.local/scripts"
  fi
  if [[ ! -f "${SCRIPTS_DIR}/Essential-IO" ]]; then
    Die "Unable to find Essential-IO in ${SCRIPTS_DIR}"
  fi
  # shellcheck disable=SC1091
  source "${SCRIPTS_DIR}/Essential-IO"

  local ExecPath ExecDir LocalDir Excludes V Q N
  ExecPath="$(Realpath "$0")"
  ExecDir="$(dirname "${ExecPath}")"
  LocalDir="$(basename "${ExecDir}")"
  Excludes=( ABOUT.md README.md README )
  V=
  Q=
  N=

  if [[ "$1" =~ ^-{1,2}h(elp)?$ ]]; then
    perl -ne 's/^#[|] ?// && print' "${ExecPath}"
    return
  fi
  while [[ "$1" =~ ^- ]]; do
    if   [[ "$1" == "-v" ]]; then V="-v";
    elif [[ "$1" == "-q" ]]; then Q="-q";
    elif [[ "$1" == "-n" ]]; then N="-n";
    elif [[ "$1" == "-C" ]]; then 
      if [[ $# -lt 2 ]]; then Report_error "Missing argument for directory"; fi
      cd "$2" || Report_fatal "Unable to cd into $2"
      shift
    fi
    shift;
  done

  if [[ $# == 0 ]]; then
    set "${HOME}/.local/${LocalDir}"
  fi
  local MasterDir MasterFile LocalFile
  local errors=0
  for MasterDir in "$@"; do
    if [[ -d "${MasterDir}" ]]; then continue; fi
    Report_error "'${MasterDir}' must be a directory"
    (( ++errors ))
  done
  if [[ ${errors} -gt 0 ]]; then
    return 1
  fi

  for MasterDir in "$@"; do
    for LocalFile in *; do
      if Excluded "${LocalFile}" "${Excludes[@]}"; then continue; fi
      MasterFile="${MasterDir}/${LocalFile}"
      if [[ -e "${MasterFile}" ]]; then
        Report_info "Updating ${LocalFile}" 
        if [[ "${N}" == "" && "${Q}" == "" ]]; then
          _do rsync -auq "${V}" "${MasterFile}" ./
        else
          _do "${N}" "${Q}" rsync -auq "${V}" "${MasterFile}" ./
        fi
      fi
    done
  done
}

Update-local "$@"
